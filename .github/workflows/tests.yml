# Имя вашего workflow, которое будет отображаться в интерфейсе GitHub Actions
name: UI tests

# Указываем, когда будет запускаться данный workflow
on:
  push:
    branches:
      - master  # Запускать workflow, когда будет сделан коммит в ветку main
  pull_request:
    branches:
      - master  # Запускать workflow, когда будет сделан pull request в ветку main

# Определяем все шаги, которые должны быть выполнены в рамках работы с тестами
jobs:
  run-tests:
    runs-on: ubuntu-latest  # Указываем, что тесты будут запускаться на последней версии Ubuntu
    permissions:
      contents: write               # ← ПРАВА НА ЗАПИСЬ
      pages: write                  # ← ПРАВА ДЛЯ PAGES
      id-token: write               # ← ДЛЯ DEPLOY

    steps:
      # 1. Шаг, который будет клонировать ваш репозиторий на машину GitHub Actions
      - name: Check out repository
        uses: actions/checkout@v4  # Используем GitHub Action для клонирования репозитория

      # 2. Шаг для установки Python на виртуальной машине
      - name: Set up Python
        uses: actions/setup-python@v4  # Используем GitHub Action для установки Python
        with:
          python-version: '3.11'  # Устанавливаем версию Python 3.11 (можно заменить на другую версию)

      # 3. Шаг для установки всех зависимостей проекта
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # Обновляем pip до последней версии
          pip install -r requirements.txt  # Устанавливаем зависимости, указанные в requirements.txt
          playwright install --with-deps  # Устанавливаем браузеры для Playwright (если они не установлены)

      # 4. Шаг для запуска тестов с использованием pytest и генерации отчётов Allure
      - name: Run Playwright tests with pytest and generate Allure results
        run: |
          python -m pytest -sv --numprocesses=3  --alluredir=allure-results  # Запускаем тесты, отмеченные как "regression", генерируем результаты для Allure

      - name: Restore Coverage history
        uses: actions/cache/restore@v5.0.3
        with:
            path: coverage-history.json
            key: coverage-history-${{ github.run_id }}
            restore-keys: |
              coverage-history-

      - name: Generate Coverage report
        run: | 
          ui-coverage-tool save-report

      # Сохраняем историю обратно в кеш
      - name: Cache Coverage  history
        if: always()
        uses: actions/cache/save@v5.0.3
        with:
          path: coverage-history.json
          key: coverage-history-${{ github.run_id }}

      - name: Upload Coverage results
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
            name: coverage-report
            path: coverage.html

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
            name: allure-results
            path: allure-results

  publish-report:
    if: always()
    needs: [run-tests]            # чтобы репорт собирался после тестов
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Download Allure results artifact
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      # 5. Шаг для получения истории отчётов Allure, если она существует
      - name: Get Allure history
        uses: actions/checkout@v4  # Опять клонируем репозиторий, чтобы получить историю отчётов
        if: always()  # Всегда выполняем, независимо от успеха или неудачи предыдущих шагов
        continue-on-error: true  # Если здесь возникнет ошибка, workflow всё равно продолжит выполнение
        with:
          force_orphan: true
          allow_empty_commit: true
          keep_files: false
          enable_jekyll: false   # Отключает Jekyll
          ref: gh-pages  # Указываем ветку gh-pages для получения отчётов
          path: gh-pages  # Указываем путь для сохранения отчётов

      # 6. Шаг для генерации и отображения отчёта Allure
      - name: Generates Allure Report with history
        uses: simple-elf/allure-report-action@v1.13  # Используем готовое решение из GitHub Marketplace для генерации Allure отчёта
        if: always()  # Этот шаг тоже всегда выполняется
        with:
          allure_results: allure-results  # Указываем каталог с результатами тестов
          allure_history: allure-history  # Указываем каталог для истории отчётов Allure

      # 7. Шаг для деплоя отчёта Allure на GitHub Pages, чтобы его можно было просматривать в браузере
      - name: Deploy report to Github Pages
        if: always()
        run: |
          # Очистка
          rm -rf deploy_temp || true
          mkdir -p deploy_temp

          # Копируем отчёт
          cp -r allure-history/* deploy_temp/ || true

          cd deploy_temp

          # Инициализация чистого git
          git init
          git checkout --orphan gh-pages

          # Добавляем .nojekyll для GitHub Pages
          touch .nojekyll
          git add .nojekyll

          # Добавляем все файлы отчёта
          git add -A .
          git -c user.name="GitHub Actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "Allure Report ${{ github.run_id }} (${{ github.sha }})"

          # Push в gh-pages (создаст ветку автоматически)
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git branch -M gh-pages
          git push -f origin gh-pages

          cd .. && rm -rf deploy_temp
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


